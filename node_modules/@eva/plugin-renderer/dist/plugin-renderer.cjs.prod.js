"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@eva/eva.js"),r=require("@eva/renderer-adapter"),t=require("lodash-es/isEqual"),n=require("eventemitter3"),a=require("pixi.js");function o(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var i=o(t),c=o(n),s=function(e,r){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};function l(e,r){function t(){this.constructor=e}s(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}var p=function(){return(p=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e}).apply(this,arguments)};function h(e,r,t,n){var a,o=arguments.length,i=o<3?r:null===n?n=Object.getOwnPropertyDescriptor(r,t):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,r,t,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(i=(o<3?a(i):o>3?a(r,t,i):a(r,t))||i);return o>3&&i&&Object.defineProperty(r,t,i),i}function u(e){var r="function"==typeof Symbol&&e[Symbol.iterator],t=0;return r?r.call(e):{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}function f(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,a,o=t.call(e),i=[];try{for(;(void 0===r||r-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(a)throw a.error}}return i}function d(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(f(arguments[r]));return e}var v,y=function(){function r(e){var r=e.game,t=e.rendererSystem;this.renderers=[],this.game=r,this.rendererSystem=t}return r.prototype.register=function(){for(var e,r,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{for(var a=u(t),o=a.next();!o.done;o=a.next()){var i=o.value;i.game=this.game,i.rendererManager=this.rendererSystem.rendererManager,i.containerManager=this.rendererSystem.containerManager,this.renderers.push(i)}}catch(r){e={error:r}}finally{try{o&&!o.done&&(r=a.return)&&r.call(a)}finally{if(e)throw e.error}}},r.prototype.componentChanged=function(r){var t,n,a=function(r){var t,n;try{for(var a=(t=void 0,u(o.renderers)),c=a.next();!c.done;c=a.next()){var s=c.value,l=s.observerInfo[r.componentName];if(l){if([e.OBSERVER_TYPE.ADD,e.OBSERVER_TYPE.REMOVE].indexOf(r.type)>-1){try{s.componentChanged&&s.componentChanged(r)}catch(e){console.error("gameObject: "+r.gameObject.name+", "+r.componentName+" is error.",r,e)}continue}if(l.findIndex((function(e){return i(e,r.prop)}))>-1)try{s.componentChanged&&s.componentChanged(r)}catch(e){console.error("gameObject: "+(r.gameObject&&r.gameObject.name)+", "+r.componentName+" is componentChanged error.",r,e)}}}}catch(e){t={error:e}}finally{try{c&&!c.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}},o=this;try{for(var c=u(r),s=c.next();!s.done;s=c.next()){a(s.value)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}},r.prototype.update=function(e){var r,t,n,a;try{for(var o=u(e.components),i=o.next();!i.done;i=o.next()){var c=i.value;try{for(var s=(n=void 0,u(this.renderers)),l=s.next();!l.done;l=s.next()){var p=l.value,h=[];if(p.observerInfo[c.name]&&-1===h.indexOf(e)){h.push(e);try{p.rendererUpdate&&p.rendererUpdate(e)}catch(r){console.info("gameObject: "+e.name+", "+c.name+" is update error",r)}}}}catch(e){n={error:e}}finally{try{l&&!l.done&&(a=s.return)&&a.call(s)}finally{if(n)throw n.error}}}}catch(e){r={error:e}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(r)throw r.error}}},r}(),m=function(){function e(){this.containerMap={}}return e.prototype.addContainer=function(e){var r=e.name,t=e.container;this.containerMap[r]=t},e.prototype.getContainer=function(e){return this.containerMap[e]},e.prototype.removeContainer=function(e){var r;null===(r=this.containerMap[e])||void 0===r||r.destroy({children:!0}),delete this.containerMap[e]},e.prototype.updateTransform=function(e){var r=e.name,t=e.transform,n=this.containerMap[r];if(n){var a=t.anchor,o=t.origin,i=t.position,c=t.rotation,s=t.scale,l=t.size,p=t.skew;n.rotation=c,n.scale=s,n.pivot.x=l.width*o.x,n.pivot.y=l.height*o.y,n.skew=p;var h=i.x,u=i.y;if(t.parent){var f=t.parent;h+=f.size.width*a.x,u+=f.size.height*a.y}n.position={x:h,y:u}}},e}(),g=function(t){function n(e){var r=e.system,n=e.containerManager,a=t.call(this)||this;return a.name="Transform",a.waitRemoveIds=[],a.waitChangeScenes=[],a.containerManager=n,a.init(r),a}return l(n,t),n.prototype.init=function(e){var r=this;this.system=e,this.on("changeScene",(function(e){var t=e.scene,n=e.mode,a=e.application;r.waitChangeScenes.push({scene:t,mode:n,application:a})}))},n.prototype.update=function(){var e,r,t,n;try{for(var a=u(this.waitRemoveIds),o=a.next();!o.done;o=a.next()){var i=o.value;this.containerManager.removeContainer(i)}}catch(r){e={error:r}}finally{try{o&&!o.done&&(r=a.return)&&r.call(a)}finally{if(e)throw e.error}}this.waitRemoveIds=[];try{for(var c=u(this.waitChangeScenes),s=c.next();!s.done;s=c.next()){var l=s.value,p=this.containerManager.getContainer(l.scene.id);p&&(l.application.stage.removeChildren(),l.application.stage.addChild(p))}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}this.waitChangeScenes=[]},n.prototype.componentChanged=function(r){r.type===e.OBSERVER_TYPE.ADD?this.addContainer(r):r.type===e.OBSERVER_TYPE.CHANGE?this.change(r):r.type===e.OBSERVER_TYPE.REMOVE&&this.waitRemoveIds.push(r.gameObject.id)},n.prototype.addContainer=function(e){var t=new r.Container;t.name=e.gameObject.name,this.containerManager.addContainer({name:e.gameObject.id,container:t}),e.component.worldTransform=t.transform.worldTransform},n.prototype.change=function(e){var r=e.component;if(r.parent){this.containerManager.getContainer(r.parent.gameObject.id).addChild(this.containerManager.getContainer(e.gameObject.id));var t=e.gameObject.transform.parent&&e.gameObject.transform.parent.gameObject.getComponent("Render");t&&(t.sortDirty=!0)}else{var n=this.containerManager.getContainer(e.gameObject.id);delete r.worldTransform,n.parent&&n.parent.removeChild(n)}},n.prototype.destroy=function(){this.removeAllListeners(),this.waitRemoveIds=null,this.waitChangeScenes=null,this.system=null,this.containerManager=null},n=h([e.decorators.componentObserver({Transform:["_parent"]})],n)}(c);exports.RENDERER_TYPE=void 0,(v=exports.RENDERER_TYPE||(exports.RENDERER_TYPE={}))[v.UNKNOWN=0]="UNKNOWN",v[v.WEBGL=1]="WEBGL",v[v.CANVAS=2]="CANVAS";var w=function(e){e.plugins.interaction.autoPreventDefault=!0,e.view.style.touchAction="none"},E=function(e){e.plugins.interaction.autoPreventDefault=!1,e.view.style.touchAction="auto"},O=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.multiApps=[],e}return l(n,t),n.prototype.init=function(r){var t=this;this.params=r,this.application=this.createApplication(r),this.containerManager=new m,this.rendererManager=new y({game:this.game,rendererSystem:this}),this.game.canvas=this.application.view,this.transform=new g({system:this,containerManager:this.containerManager}),this.game.on("sceneChanged",(function(r){var n,a=r.scene,o=r.mode,i=r.params;switch(o){case e.LOAD_SCENE_MODE.SINGLE:n=t.application;break;case e.LOAD_SCENE_MODE.MULTI_CANVAS:n=t.createMultiApplication({params:i})}a.canvas=n.view,t.transform.emit("changeScene",{scene:a,mode:o,application:n})}))},n.prototype.registerObserver=function(e){var r,t=this.constructor.observerInfo;for(var n in e)t[n]||(t[n]=[]),(r=t[n]).push.apply(r,d(e[n]))},n.prototype.createMultiApplication=function(e){var r=e.params,t=this.createApplication(r);return this.multiApps.push(t),t},n.prototype.createApplication=function(e){e.view=e.canvas,e.renderType===exports.RENDERER_TYPE.CANVAS&&(e.forceCanvas=!0),a.ticker.shared.autoStart=!1,a.ticker.shared.stop();var t=new r.Application(p({sharedTicker:!0},e));return void 0!==e.preventScroll&&(console.warn("PreventScroll property will deprecate at next major version, please use enableEnable instead. https://eva.js.org/#/tutorials/game"),e.preventScroll?E(t.renderer):w(t.renderer)),void 0!==e.enableScroll&&(e.enableScroll?E(t.renderer):w(t.renderer)),void 0===e.preventScroll&&void 0===e.enableScroll&&E(t.renderer),t},n.prototype.update=function(){var e,r,t,n,a=this.componentObserver.clear();try{for(var o=u(a),i=o.next();!i.done;i=o.next()){var c=i.value;this.transform.componentChanged(c)}}catch(r){e={error:r}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}try{for(var s=u(this.game.gameObjects),l=s.next();!l.done;l=s.next()){var p=l.value;this.containerManager.updateTransform({name:p.id,transform:p.transform}),this.rendererManager.update(p)}}catch(e){t={error:e}}finally{try{l&&!l.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}},n.prototype.lateUpdate=function(e){this.transform.update(),this.application.ticker.update(e.time)},n.prototype.onDestroy=function(){var e,r;this.application.destroy();try{for(var t=u(this.multiApps),n=t.next();!n.done;n=t.next()){var a=n.value;a&&a.destroy()}}catch(r){e={error:r}}finally{try{n&&!n.done&&(r=t.return)&&r.call(t)}finally{if(e)throw e.error}}this.transform.destroy(),this.transform=null,this.params=null,this.rendererManager=null,this.containerManager=null,this.application=null,this.game=null,this.multiApps=null},n.prototype.resize=function(e,r){this.params.width=e,this.params.height=r,this.application.renderer.resize(e,r)},n.systemName="Renderer",n=h([e.decorators.componentObserver({Transform:["_parent"]})],n)}(e.System),b=function(e){function r(r){var t=e.call(this,r)||this;return t.observerInfo=t.constructor.observerInfo,t}return l(r,e),r.prototype.componentChanged=function(e){},r.prototype.rendererUpdate=function(e){},r.prototype.update=function(e){var r,t,n=this.componentObserver.clear();try{for(var a=u(n),o=a.next();!o.done;o=a.next()){var i=o.value;this.componentChanged(i)}}catch(e){r={error:e}}finally{try{o&&!o.done&&(t=a.return)&&t.call(a)}finally{if(r)throw r.error}}},r}(e.System);exports.ContainerManager=m,exports.Renderer=b,exports.RendererManager=y,exports.RendererSystem=O;
